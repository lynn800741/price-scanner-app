<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>LENSY - 萬物價格掃描器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: #fff;
        }

        /* 頁面容器 */
        .page {
            display: none;
            min-height: 100vh;
            position: relative;
        }

        .page.active {
            display: block;
        }

        /* 頂部導航欄 */
        .nav-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            background: #fff;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #eee;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* 底部導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-nav.hidden {
            display: none;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            fill: #999;
            margin-bottom: 4px;
        }

        .nav-item.active svg {
            fill: #FF6B35;
        }

        .nav-item span {
            font-size: 12px;
            color: #999;
        }

        .nav-item.active span {
            color: #FF6B35;
        }

        /* 相機按鈕特殊樣式 */
        .nav-camera {
            position: relative;
        }

        .camera-btn {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .camera-btn svg {
            width: 30px;
            height: 30px;
            fill: #fff;
        }

        /* 設定頁面樣式 */
        .settings-page {
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #FF6B35;
            margin: 20px 20px 10px;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .list-item-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .list-item-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            fill: #666;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-size: 16px;
            color: #333;
        }

        .list-item-subtitle {
            font-size: 14px;
            color: #999;
            margin-top: 2px;
        }

        .list-item-arrow {
            width: 20px;
            height: 20px;
            fill: #999;
        }

        /* Switch 開關 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #FF6B35;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* 相機頁面 */
        .camera-page {
            position: relative;
            height: 100vh;
            background: #000;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .close-camera {
            position: absolute;
            top: 40px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
        }

        .close-camera svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        /* 掃描框 */
        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .scan-text {
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .scan-frame {
            width: 280px;
            height: 280px;
            position: relative;
        }

        /* 四角邊框樣式 */
        .scan-frame::before,
        .scan-frame::after,
        .scan-corner-tl,
        .scan-corner-tr {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #fff;
        }

        .scan-frame::before {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }

        .scan-frame::after {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }

        .scan-corner-tl {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }

        .scan-corner-tr {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }

        /* 底部控制 */
        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            pointer-events: all;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            cursor: pointer;
        }

        .capture-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
        }

        /* 照片列表頁 */
        .list-page {
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .search-container {
            padding: 10px 20px;
            background: #fff;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 10px 15px;
        }

        .search-icon {
            width: 20px;
            height: 20px;
            fill: #999;
            margin-right: 10px;
        }

        .search-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 16px;
            outline: none;
        }

        .select-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .select-btn:hover {
            background: #e0e0e0;
        }

        .select-btn.active {
            background: #FF6B35;
            color: white;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            padding: 20px;
        }

        .empty-icon {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .empty-icon svg {
            width: 50px;
            height: 50px;
            fill: #ccc;
        }

        .empty-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 14px;
            color: #999;
        }

        /* 批量操作工具列 */
        .batch-toolbar {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .batch-toolbar.active {
            bottom: 0;
        }

        .batch-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-share-btn {
            background: #2196F3;
            color: white;
        }

        .batch-share-btn:hover {
            background: #1976D2;
        }

        .batch-delete-btn {
            background: #f44336;
            color: white;
        }

        .batch-delete-btn:hover {
            background: #d32f2f;
        }

        .batch-count {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* 選取模式下隱藏底部導航 */
        .select-mode .bottom-nav {
            display: none;
        }

        /* 載入動畫 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #fff;
            font-size: 18px;
        }

        /* 結果頁面 - 新增單獨頁面樣式 */
        .result-page {
            padding-top: 60px;
            padding-bottom: 80px;
            background: #f5f5f5;
        }

        .result-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            background: #fff;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .result-back-btn {
            width: 35px;
            height: 35px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-back-btn:hover {
            background: #e0e0e0;
        }

        .result-back-btn svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }

        .result-menu-btn {
            width: 35px;
            height: 35px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-menu-btn:hover {
            background: #e0e0e0;
        }

        .result-menu-btn svg {
            width: 20px;
            height: 20px;
            fill: #666;
        }

        /* 下拉選單 */
        .result-dropdown {
            position: absolute;
            top: 50px;
            right: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 2001;
            min-width: 180px;
        }

        .result-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item svg {
            width: 18px;
            height: 18px;
            fill: #666;
        }

        .dropdown-item.delete {
            color: #f44336;
        }

        .dropdown-item.delete svg {
            fill: #f44336;
        }

        /* 編輯名稱對話框 */
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .edit-dialog.active {
            display: flex;
        }

        .edit-dialog-content {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .edit-dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .edit-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .edit-dialog-buttons {
            display: flex;
            gap: 10px;
        }

        .edit-dialog-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .edit-dialog-btn.save {
            background: #4CAF50;
            color: white;
        }

        .edit-dialog-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }

        .result-content {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .result-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .price-section {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8A65 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .price-value {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        .info-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .info-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .info-card-content {
            font-size: 15px;
            color: #666;
            line-height: 1.6;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-chat {
            background: #4CAF50;
            color: white;
        }

        .btn-share {
            background: #2196F3;
            color: white;
        }

        /* Canvas for photo capture */
        #photoCanvas {
            display: none;
        }

        /* 歷史記錄樣式 */
        .history-section {
            padding: 0 20px;
        }

        .month-label {
            font-size: 16px;
            font-weight: 600;
            color: #666;
            margin: 20px 0 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-item {
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .history-item.selected {
            transform: scale(0.95);
            box-shadow: 0 0 0 3px #FF6B35;
        }

        .history-item-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #999;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
        }

        .select-mode .history-item-checkbox {
            display: flex;
        }

        .history-item-checkbox.checked {
            background: #FF6B35;
            border-color: #FF6B35;
        }

        .history-item-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .history-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .history-info {
            padding: 10px;
        }

        .history-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-price {
            font-size: 16px;
            color: #FF6B35;
            font-weight: 700;
        }

        .history-date {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* 文件輸入隱藏 */
        #fileInput {
            display: none;
        }

        /* 聊天頁面樣式 */
        .chat-page {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fff;
            z-index: 3000;
            display: none;
            flex-direction: column;
        }

        .chat-page.active {
            display: flex;
        }

        .chat-header {
            position: relative;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chat-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 35px;
            height: 35px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-close-btn:hover {
            background: #e0e0e0;
        }

        .chat-close-btn svg {
            width: 18px;
            height: 18px;
            fill: #666;
        }

        /* 重新查看圖片按鈕區域 */
        .view-image-section {
            padding: 10px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: center;
        }

        .view-image-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-image-btn:hover {
            background: #f5f5f5;
            color: #333;
            border-color: #999;
        }

        .view-image-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }

        /* 引導詞區域 */
        .quick-prompts {
            padding: 10px 20px;
            background: #fff;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .prompt-chip {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .prompt-chip:hover {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
        }

        .message {
            margin-bottom: 24px;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }

        .message.user .message-content {
            max-width: 70%;
            padding: 12px 16px;
            background: #FF6B35;
            color: white;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: 15px;
        }

        .message.assistant {
            margin-bottom: 32px;
        }

        .message.assistant .message-content {
            color: #2d2d2d;
            line-height: 1.8;
            font-size: 15px;
        }

        /* AI 訊息的 Markdown 樣式 */
        .message.assistant .message-content h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 20px 0 16px 0;
            color: #1a1a1a;
        }

        .message.assistant .message-content h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 18px 0 14px 0;
            color: #2d2d2d;
        }

        .message.assistant .message-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 16px 0 12px 0;
            color: #2d2d2d;
        }

        .message.assistant .message-content p {
            margin: 12px 0;
        }

        .message.assistant .message-content strong {
            font-weight: 600;
            color: #1a1a1a;
        }

        .message.assistant .message-content em {
            font-style: italic;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message.assistant .message-content li {
            margin: 6px 0;
            line-height: 1.7;
        }

        .message.assistant .message-content code {
            background: #f6f6f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 14px;
            color: #d73a49;
        }

        .message.assistant .message-content pre {
            background: #f6f6f6;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .message.assistant .message-content pre code {
            background: none;
            padding: 0;
            color: #2d2d2d;
        }

        .message.assistant .message-content blockquote {
            border-left: 3px solid #FF6B35;
            padding-left: 16px;
            margin: 16px 0;
            color: #666;
            font-style: italic;
        }

        .message.assistant .message-content a {
            color: #FF6B35;
            text-decoration: none;
            font-weight: 500;
        }

        .message.assistant .message-content a:hover {
            text-decoration: underline;
        }

        .message.assistant .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        .message.assistant .message-content th,
        .message.assistant .message-content td {
            border: 1px solid #e5e5e5;
            padding: 8px 12px;
            text-align: left;
        }

        .message.assistant .message-content th {
            background: #f9f9f9;
            font-weight: 600;
        }

        .chat-input-area {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #FF6B35;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #FF6B35;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: #ff5722;
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .chat-loading {
            display: inline-flex;
            gap: 4px;
            padding: 8px 0;
        }

        .chat-loading span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: chatLoading 1.4s ease-in-out infinite;
        }

        .chat-loading span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chat-loading span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes chatLoading {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .disclaimer-text {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 10px;
        }

        /* 登入/註冊頁面樣式 */
        .auth-page {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fff;
            z-index: 4500;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .auth-page.active {
            display: flex;
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(100%);
            }
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        .auth-header {
            position: relative;
            padding: 15px 20px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-close-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 35px;
            height: 35px;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .auth-close-btn svg {
            width: 24px;
            height: 24px;
            fill: #333;
        }

        .auth-content {
            flex: 1;
            padding: 20px 30px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .auth-logo {
            font-size: 48px;
            font-weight: 800;
            color: #FF6B35;
            margin-bottom: 10px;
            letter-spacing: -2px;
        }

        .auth-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
        }

        .auth-form {
            width: 100%;
            max-width: 350px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .form-input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .form-input:focus {
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .password-toggle {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }

        .password-toggle svg {
            width: 20px;
            height: 20px;
            fill: #999;
        }

        .forgot-password {
            display: inline-block;
            font-size: 14px;
            color: #FF6B35;
            text-decoration: none;
            margin-bottom: 24px;
            cursor: pointer;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .auth-button:hover {
            background: #ff5722;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
        }

        .auth-switch {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        .auth-switch a {
            color: #FF6B35;
            text-decoration: none;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: #999;
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            padding: 0 16px;
        }

        .social-login {
            width: 100%;
            max-width: 350px;
        }

        .social-button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .social-button:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .social-button svg {
            width: 20px;
            height: 20px;
        }

        .apple-button {
            background: #000;
            color: #fff;
            border: none;
        }

        .apple-button:hover {
            background: #333;
        }

        .terms-text {
            font-size: 12px;
            color: #999;
            text-align: center;
            line-height: 1.6;
            margin-top: 30px;
        }

        .terms-text a {
            color: #666;
            text-decoration: underline;
        }

        .terms-text a:hover {
            color: #FF6B35;
        }
        .pro-upgrade-page {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fff;
            z-index: 4000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .pro-upgrade-page.active {
            display: flex;
        }

        .pro-header {
            position: relative;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pro-close-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 35px;
            height: 35px;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .pro-close-btn svg {
            width: 24px;
            height: 24px;
            fill: #333;
        }

        .pro-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 150px;
        }

        .pro-hero {
            text-align: center;
            margin-bottom: 20px;
        }

        .pro-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8A65 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .pro-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .pro-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .trial-info {
            font-size: 18px;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .features-list {
            margin-bottom: 30px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: #FFF3E0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .feature-icon svg {
            width: 24px;
            height: 24px;
            fill: #FF6B35;
        }

        .feature-text {
            flex: 1;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .feature-desc {
            font-size: 14px;
            color: #666;
        }

        .pricing-section {
            margin-bottom: 20px;
        }

        .pricing-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .pricing-card {
            flex: 1;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            text-align: center;
        }

        .pricing-card.selected {
            border-color: #FF6B35;
            background: #FFF3E0;
            transform: scale(1.02);
        }

        .pricing-card.popular {
            position: relative;
        }

        .discount-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .pricing-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #999;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 10px;
        }

        .pricing-card.selected .pricing-radio {
            border-color: #FF6B35;
        }

        .pricing-card.selected .pricing-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #FF6B35;
            border-radius: 50%;
        }

        .pricing-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .pricing-price {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .pricing-note {
            font-size: 13px;
            color: #999;
        }

        .pricing-period {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .bottom-section {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: #fff;
            padding: 15px 20px 25px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .subscribe-btn {
            width: 100%;
            padding: 16px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .subscribe-btn:hover {
            background: #ff5722;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
        }

        .terms-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 12px;
        }

        .terms-links a {
            color: #666;
            text-decoration: none;
            transition: color 0.3s;
        }

        .terms-links a:hover {
            color: #FF6B35;
        }
        
        /* AI上傳頁面樣式 */
        .ai-upload-page {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #fff;
            z-index: 3500;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .ai-upload-page.active {
            display: flex;
            animation: fadeIn 0.3s ease forwards;
        }

        .ai-upload-header {
            position: relative;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-upload-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .ai-upload-close-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 35px;
            height: 35px;
            background: #f5f5f5;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-upload-close-btn:hover {
            background: #e0e0e0;
        }

        .ai-upload-close-btn svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }

        .ai-upload-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .upload-box {
            width: 100%;
            max-width: 350px;
            padding: 60px 40px;
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #FF6B35;
            background: #FFF3E0;
        }

        .upload-icon-container {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: #FF6B35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
            position: relative;
            overflow: hidden;
        }

        .upload-icon-container:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 107, 53, 0.4);
        }
        
        .upload-icon-container:active {
            transform: scale(0.95);
        }
        
        .upload-icon-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .upload-icon-container:hover::before {
            width: 100px;
            height: 100px;
        }

        .upload-icon-container svg {
            width: 50px;
            height: 50px;
            fill: white;
        }

        .upload-text {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
        }

        .upload-tips {
            margin-top: 30px;
            padding: 15px;
            background: #FFF3E0;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .upload-tips-title {
            font-weight: 600;
            color: #FF6B35;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 設定頁面 -->
        <div class="page settings-page" id="settingsPage">
            <div class="nav-header">
                <h1 class="app-title">設定</h1>
            </div>
            
            <div class="section">
                <h2 class="section-title">會員服務</h2>
                
                <div class="list-item" onclick="openProUpgrade()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M5 16L3 5l5.5 0L12 16m3.5 0H21l-2-11L14 5"/>
                        </svg>
                        <div class="list-item-content">
                            <div class="list-item-title">會員狀態</div>
                            <div class="list-item-subtitle">免費版</div>
                        </div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-item-title" style="margin-left: 39px;">剩餘掃描次數: 50</div>
                    </div>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        <div class="list-item-title">復原購買</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Pro 版功能</h2>
                
                <div class="list-item" onclick="openAIUpload()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M22 2.53L16.47 8 13 11.5l-1.5 1.5L8 16.47 2.53 22 1 20.47 6.47 15 11 10.5l1.5-1.5L16 5.47 20.47 1 22 2.53M10.94 13L2 22v-2l8.94-9L11 11l-.06 2M13 10.94L22 2h-2l-9 8.94v.12L13 13v-2.06"/>
                        </svg>
                        <div class="list-item-title">AI智能服務</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item" onclick="openExportDialog()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z"/>
                        </svg>
                        <div class="list-item-title">匯出成Excel報告</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item" onclick="openBatchAnalysis()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <div class="list-item-title">多張照片批次辨識</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                        </svg>
                        <div class="list-item-title">自動儲存到相簿</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="autoSaveToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">帳號</h2>
                
                <div class="list-item" onclick="handleLogin()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <div class="list-item-title">登入/註冊</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">支援</h2>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M21 9L17.5 14.5C17.08 15.08 16.5 15.5 15.91 15.68L11.7 16.89C11.45 16.96 11.21 17 11 17C10.5 17 10.08 16.76 9.82 16.3L7.91 12.72C7.66 12.17 7.9 11.5 8.47 11.28L12.66 9.61C13.22 9.39 13.86 9.63 14.12 10.2L15.38 12.94L18.5 8.5L21 9Z"/>
                        </svg>
                        <div class="list-item-title">語言</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                        </svg>
                        <div class="list-item-title">聯絡我們</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item" onclick="showHelp()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                        </svg>
                        <div class="list-item-title">輔助說明</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">關於APP</h2>
                
                <div class="list-item" onclick="showAppInfo()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                        </svg>
                        <div class="list-item-title">APP資訊</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item" onclick="rateApp()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                        </svg>
                        <div class="list-item-title">評價APP</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
                
                <div class="list-item" onclick="shareApp()">
                    <div class="list-item-left">
                        <svg class="list-item-icon" viewBox="0 0 24 24">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                        <div class="list-item-title">分享給朋友</div>
                    </div>
                    <svg class="list-item-arrow" viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 相機頁面 -->
        <div class="page camera-page" id="cameraPage">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="photoCanvas"></canvas>
            
            <div class="camera-overlay">
                <div class="close-camera" onclick="goToHome()">
                    <svg viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </div>

                <div class="scan-area">
                    <p class="scan-text">確保物品清晰地位於鏡頭焦點中</p>
                    <div class="scan-frame" id="scanFrame">
                        <span class="scan-corner-tl"></span>
                        <span class="scan-corner-tr"></span>
                    </div>
                </div>

                <div class="camera-controls">
                    <button class="control-btn" onclick="document.getElementById('multiFileInput').click()">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </button>
                    
                    <button class="capture-btn" onclick="capturePhoto()"></button>
                    
                    <button class="control-btn" onclick="toggleFlash()">
                        <svg viewBox="0 0 24 24">
                            <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
                        </svg>
                    </button>
                </div>
                
                <p style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 12px;">
                    長按拍照按鈕可選擇單張照片
                </p>
            </div>
        </div>

        <!-- 照片列表頁面 -->
        <div class="page list-page active" id="listPage">
            <div class="nav-header">
                <h1 class="app-title">LENSY</h1>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" class="search-input" placeholder="搜尋" id="searchInput" oninput="searchHistory()">
                </div>
                <button class="select-btn" id="selectBtn" onclick="toggleSelectMode()">選取</button>
            </div>
            
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 4h7V2H4c-1.1 0-2 .9-2 2v7h2V4zm6 9l-4 5h12l-3.5-4.5-2.5 3.01L10 13zM22 11V4c0-1.1-.9-2-2-2h-7v2h7v7h2zm-2 9h-7v2h7c1.1 0 2-.9 2-2v-7h-2v7zM4 13H2v7c0 1.1.9 2 2 2h7v-2H4v-7z"/>
                    </svg>
                </div>
                <h3 class="empty-title">拍攝你的第一張照片</h3>
                <p class="empty-subtitle">開始建立你的價格卡</p>
            </div>
            
            <div class="history-section" id="historySection" style="display: none;">
                <!-- 歷史記錄會動態加入這裡 -->
            </div>
        </div>

        <!-- 結果頁面 - 修改為單獨頁面 -->
        <div class="page result-page" id="resultPage">
            <div class="result-header">
                <button class="result-back-btn" onclick="closeResult()">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1 class="app-title">分析結果</h1>
                <button class="result-menu-btn" onclick="toggleResultMenu()">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="5" r="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <circle cx="12" cy="19" r="2"/>
                    </svg>
                </button>
            </div>
            
            <div class="result-dropdown" id="resultDropdown">
                <div class="dropdown-item" onclick="reanalyzeImage()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                    更正物品識別
                </div>
                <div class="dropdown-item" onclick="editItemName()">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    編輯名稱
                </div>
                <div class="dropdown-item delete" onclick="deleteCurrentItem()">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    刪除
                </div>
            </div>
            
            <div class="result-content" id="resultContent">
                <!-- 動態內容會插入這裡 -->
            </div>
        </div>

        <!-- 批量操作工具列 -->
        <div class="batch-toolbar" id="batchToolbar">
            <button class="batch-action-btn batch-share-btn" onclick="batchShare()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                </svg>
                分享
            </button>
            <span class="batch-count">已選取 <span id="selectedCount">0</span> 個</span>
            <button class="batch-action-btn batch-delete-btn" onclick="batchDelete()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                刪除
            </button>
        </div>

        <!-- 底部導航 -->
        <div class="bottom-nav" id="bottomNav">
            <div class="nav-item active" onclick="switchPage('listPage')">
                <svg viewBox="0 0 24 24">
                    <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                </svg>
                <span>照片列表</span>
            </div>
            
            <div class="nav-item nav-camera">
                <div class="camera-btn" onclick="switchPage('cameraPage')">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                    </svg>
                </div>
            </div>
            
            <div class="nav-item" onclick="switchPage('settingsPage')">
                <svg viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span>設定</span>
            </div>
        </div>

        <!-- 編輯名稱對話框 -->
        <div class="edit-dialog" id="editDialog">
            <div class="edit-dialog-content">
                <h3 class="edit-dialog-title">編輯名稱</h3>
                <input type="text" class="edit-input" id="editNameInput" placeholder="輸入新名稱">
                <div class="edit-dialog-buttons">
                    <button class="edit-dialog-btn save" onclick="saveEditedName()">儲存</button>
                    <button class="edit-dialog-btn cancel" onclick="closeEditDialog()">取消</button>
                </div>
            </div>
        </div>

        <!-- 載入動畫 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
            <div class="loading-text">AI 正在分析中...</div>
        </div>
        
        <!-- 聊天頁面 -->
        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <h1 class="chat-title">AI 助手</h1>
                <button class="chat-close-btn" onclick="closeChat()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="view-image-section" id="viewImageSection" style="display: none;">
                <button class="view-image-btn" onclick="sendMessageWithImage('請重新查看這張圖片並告訴我你看到了什麼。')">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    重新查看圖片
                </button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 對話內容會動態加入這裡 -->
            </div>
            <div class="chat-input-area">
                <div class="quick-prompts" id="quickPrompts">
                    <span class="prompt-chip" onclick="sendQuickPrompt('這個值得買嗎？')">這個值得買嗎？</span>
                    <span class="prompt-chip" onclick="sendQuickPrompt('有更便宜的替代品嗎？')">有更便宜的替代品嗎？</span>
                    <span class="prompt-chip" onclick="sendQuickPrompt('如何保養這個物品？')">如何保養這個物品？</span>
                    <span class="prompt-chip" onclick="sendQuickPrompt('這個物品的優缺點是什麼？')">優缺點分析</span>
                    <span class="prompt-chip" onclick="sendQuickPrompt('使用時要注意什麼？')">使用注意事項</span>
                </div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" placeholder="詢問關於這個物品..." rows="1"></textarea>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 升級PRO頁面 -->
        <div class="pro-upgrade-page" id="proUpgradePage">
            <div class="pro-header">
                <button class="pro-close-btn" onclick="closeProUpgrade()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
                <h1 class="app-title">升級方案</h1>
            </div>
            
            <div class="pro-content">
                <div class="pro-hero">
                    <div class="pro-logo">L</div>
                    <h2 class="pro-title">LENSY PRO</h2>
                    <p class="pro-subtitle">解鎖所有強大功能，讓掃描分析更專業</p>
                    <p class="trial-info">3 天免費試用</p>
                </div>

                <div class="features-list">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M22 2.53L16.47 8 13 11.5l-1.5 1.5L8 16.47 2.53 22 1 20.47 6.47 15 11 10.5l1.5-1.5L16 5.47 20.47 1 22 2.53M10.94 13L2 22v-2l8.94-9L11 11l-.06 2M13 10.94L22 2h-2l-9 8.94v.12L13 13v-2.06"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">AI 智能服務</div>
                            <div class="feature-desc">更精準的物品識別與價格分析</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">每月 1000 次掃描分析</div>
                            <div class="feature-desc">滿足你的所有掃描需求</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM5 17l1.41-1.41 1.38 1.38 1.42-1.42-1.38-1.38L9.24 13l-1.41-1.41-1.42 1.41 1.38 1.38L6.42 15.59 5 17zm12-2h-5v-2h5v2zm-5-4h5v2h-5z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">去除煩人的應用程式廣告</div>
                            <div class="feature-desc">享受純淨無干擾的使用體驗</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">匯出 Excel 報告</div>
                            <div class="feature-desc">專業的數據整理與分析報告</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">多張照片批次辨識</div>
                            <div class="feature-desc">一次處理多張照片，節省時間</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <div class="feature-title">自動儲存到相簿</div>
                            <div class="feature-desc">掃描結果自動備份不遺失</div>
                        </div>
                    </div>
                </div>

                <div class="pricing-section">
                    <div class="pricing-container">
                        <div class="pricing-card popular" id="yearlyPlan" onclick="selectPlan('yearly')">
                            <div class="discount-badge">省34%</div>
                            <div class="pricing-radio"></div>
                            <div class="pricing-title">年繳方案</div>
                            <div class="pricing-price">$99</div>
                            <div class="pricing-note">每月</div>
                            <div class="pricing-period">$1,188/年</div>
                        </div>

                        <div class="pricing-card" id="monthlyPlan" onclick="selectPlan('monthly')">
                            <div class="pricing-radio"></div>
                            <div class="pricing-title">月繳方案</div>
                            <div class="pricing-price">$150</div>
                            <div class="pricing-note">每月</div>
                            <div class="pricing-period">按月計費</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bottom-section">
                <button class="subscribe-btn" onclick="startFreeTrial()">
                    開始免費試用
                </button>
                <div class="terms-links">
                    <a href="#" onclick="showTerms('usage'); return false;">使用條款</a>
                    <a href="#" onclick="showTerms('privacy'); return false;">隱私政策</a>
                    <a href="#" onclick="showTerms('subscription'); return false;">訂閱條款</a>
                    <a href="#" onclick="restorePurchase(); return false;">恢復購買</a>
                </div>
            </div>
        </div>
        
        <!-- 登入/註冊頁面 -->
        <div class="auth-page" id="authPage">
            <div class="auth-header">
                <button class="auth-close-btn" onclick="closeAuth()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <div class="auth-content">
                <h1 class="auth-logo">LENSY</h1>
                <p class="auth-subtitle">萬物價格掃描器</p>
                
                <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                    <div class="form-group">
                        <label class="form-label">電子郵件地址</label>
                        <input type="email" class="form-input" id="emailInput" placeholder="輸入您的電子郵件" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">密碼</label>
                        <div class="form-input-wrapper">
                            <input type="password" class="form-input" id="passwordInput" placeholder="輸入您的密碼" required>
                            <button type="button" class="password-toggle" onclick="togglePassword()">
                                <svg viewBox="0 0 24 24" id="eyeIcon">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <a href="#" class="forgot-password" onclick="handleForgotPassword()">忘記密碼？</a>
                    
                    <button type="submit" class="auth-button" id="authButton">登入</button>
                    
                    <div class="auth-switch" id="authSwitch">
                        尚未註冊帳號？ <a href="#" onclick="toggleAuthMode()">註冊</a>
                    </div>
                </form>
                
                <div class="divider">
                    <span>或</span>
                </div>
                
                <div class="social-login">
                    <button class="social-button apple-button" onclick="handleAppleLogin()">
                        <svg viewBox="0 0 24 24" fill="white">
                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                        </svg>
                        使用 Apple 登入
                    </button>
                    
                    <button class="social-button google-button" onclick="handleGoogleLogin()">
                        <svg viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        使用 Google 登入
                    </button>
                </div>
                
                <p class="terms-text">
                    加入 LENSY，即表示您已閱讀並同意我們的<br>
                    <a href="#" onclick="showTerms('usage')">使用條款</a> 和 <a href="#" onclick="showTerms('privacy')">隱私政策</a> 之所有內容。
                </p>
            </div>
        </div>
        
        <!-- AI上傳頁面 -->
        <div class="ai-upload-page" id="aiUploadPage">
            <div class="ai-upload-header">
                <button class="ai-upload-close-btn" onclick="closeAIUpload()">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1 class="ai-upload-title">AI智能服務</h1>
            </div>
            
            <div class="ai-upload-content">
                <div class="upload-box">
                    <div class="upload-icon-container" onclick="document.getElementById('aiFileInput').click()">
                        <svg viewBox="0 0 24 24">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
                        </svg>
                    </div>
                    <h2 class="upload-text">上傳照片與AI開始對談</h2>
                    <p class="upload-subtext">點擊上方圖示選擇照片<br>開始智能對話分析</p>
                    
                    <div class="upload-tips">
                        <div class="upload-tips-title">💡 使用提示</div>
                        • 選擇一張清晰的照片<br>
                        • AI會深度分析照片內容<br>
                        • 提供個性化的見解與建議
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 隱藏的文件輸入 -->
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        <input type="file" id="multiFileInput" accept="image/*" multiple onchange="handleMultiFileSelect(event)" style="display: none;">
        <input type="file" id="aiFileInput" accept="image/*" onchange="handleAIFileSelect(event)" style="display: none;">
    </div>

    <script>
        // 全域變數
        let stream = null;
        let capturedImage = null;
        let currentAnalysisData = null;
        let flashMode = 'off';
        let currentChatItemId = null;
        let isSelectMode = false;
        let selectedItems = new Set();
        let currentHistoryItem = null;
        let selectedPricingPlan = 'yearly'; // 預設選擇年繳方案
        
        // 價格配置
        const PRICING = {
            monthly: 150,
            yearly: 1188  // 99 * 12
        };
        
        // 價格格式化函數 - 統一所有價格顯示
        function formatPrice(price) {
            // 如果已經有 $ 符號，先移除
            let priceString = price.toString().replace(/[$,]/g, '');
            
            // 嘗試解析數字
            let numericPrice = parseFloat(priceString);
            
            // 如果不是有效數字，返回原始值
            if (isNaN(numericPrice)) {
                return price;
            }
            
            // 格式化為整數，加上千位分隔符
            let formattedPrice = Math.round(numericPrice).toLocaleString('zh-TW');
            
            // 加上 $ 符號
            return '$' + formattedPrice;
        }
        
        // 計算折扣百分比
        function calculateDiscount() {
            const monthlyYearTotal = PRICING.monthly * 12;
            const yearlyTotal = PRICING.yearly;
            const discount = ((monthlyYearTotal - yearlyTotal) / monthlyYearTotal * 100).toFixed(0);
            return discount;
        }
        
        // DOM 元素
        const pages = {
            settingsPage: document.getElementById('settingsPage'),
            cameraPage: document.getElementById('cameraPage'),
            listPage: document.getElementById('listPage'),
            resultPage: document.getElementById('resultPage')  // 新增結果頁面
        };
        
        const bottomNav = document.getElementById('bottomNav');
        const chatPage = document.getElementById('chatPage');
        const proUpgradePage = document.getElementById('proUpgradePage');
        const aiUploadPage = document.getElementById('aiUploadPage');
        const authPage = document.getElementById('authPage');
        
        // 全域變數儲存當前模式
        let isLoginMode = true;
        
        // 初始化應用
        window.addEventListener('load', () => {
            // 檢查並顯示歷史記錄
            displayHistory();
            // 設定拍照按鈕長按功能
            setupCaptureButton();
            // 預設選擇年繳方案
            selectPlan('yearly');
            // 更新折扣顯示
            updateDiscountBadge();
        });
        
        // 更新折扣標籤
        function updateDiscountBadge() {
            const discountBadge = document.querySelector('.discount-badge');
            if (discountBadge) {
                const discount = calculateDiscount();
                discountBadge.textContent = `省${discount}%`;
            }
        }
        
        // 打開升級PRO頁面
        function openProUpgrade() {
            proUpgradePage.classList.add('active');
            // 更新價格顯示和折扣
            updatePricingDisplay();
        }
        
        // 更新價格顯示
        function updatePricingDisplay() {
            // 更新折扣標籤
            updateDiscountBadge();
            
            // 更新年繳月均價
            const yearlyMonthlyPrice = Math.round(PRICING.yearly / 12);
            const yearlyPriceElement = document.querySelector('#yearlyPlan .pricing-price');
            if (yearlyPriceElement) {
                yearlyPriceElement.textContent = formatPrice(yearlyMonthlyPrice);
            }
            
            // 更新年繳總價
            const yearlyPeriodElement = document.querySelector('#yearlyPlan .pricing-period');
            if (yearlyPeriodElement) {
                yearlyPeriodElement.textContent = `${formatPrice(PRICING.yearly)}/年`;
            }
            
            // 更新月繳價格
            const monthlyPriceElement = document.querySelector('#monthlyPlan .pricing-price');
            if (monthlyPriceElement) {
                monthlyPriceElement.textContent = formatPrice(PRICING.monthly);
            }
        }
        
        // 關閉升級PRO頁面
        function closeProUpgrade() {
            proUpgradePage.classList.remove('active');
        }
        
        // 選擇方案
        function selectPlan(plan) {
            selectedPricingPlan = plan;
            
            // 移除所有選中狀態
            document.querySelectorAll('.pricing-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 添加選中狀態
            if (plan === 'yearly') {
                document.getElementById('yearlyPlan').classList.add('selected');
            } else {
                document.getElementById('monthlyPlan').classList.add('selected');
            }
        }
        
        // 開始免費試用
        function startFreeTrial() {
            const yearlyYearTotal = formatPrice(PRICING.yearly);
            const monthlyTotal = formatPrice(PRICING.monthly);
            const yearlyMonthly = formatPrice(Math.round(PRICING.yearly / 12));
            
            const planText = selectedPricingPlan === 'yearly' 
                ? `年繳方案（${yearlyYearTotal}/年，平均每月 ${yearlyMonthly}）` 
                : `月繳方案（${monthlyTotal}/月）`;
                
            alert(`即將開始 3 天免費試用\n\n您選擇的是：${planText}\n\n試用期結束後將自動扣款\n\n此功能尚在開發中，敬請期待！`);
            
            // 這裡可以加入實際的訂閱邏輯
            // 例如：調用支付 API、記錄用戶訂閱狀態等
            
            closeProUpgrade();
        }
        
        // 顯示條款
        function showTerms(type) {
            const termsMap = {
                'usage': '使用條款',
                'privacy': '隱私政策',
                'subscription': '訂閱條款'
            };
            
            alert(`${termsMap[type]}功能即將推出！`);
        }
        
        // 恢復購買
        function restorePurchase() {
            alert('恢復購買功能即將推出！\n\n如果您之前已經購買過，將可以在此恢復您的訂閱。');
        }
        
        // 處理登入/註冊
        function handleLogin() {
            authPage.classList.add('active');
        }
        
        // 關閉認證頁面
        function closeAuth() {
            authPage.classList.remove('active');
        }
        
        // 切換密碼顯示
        function togglePassword() {
            const passwordInput = document.getElementById('passwordInput');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
            } else {
                passwordInput.type = 'password';
                eyeIcon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
            }
        }
        
        // 切換登入/註冊模式
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authButton = document.getElementById('authButton');
            const authSwitch = document.getElementById('authSwitch');
            
            if (isLoginMode) {
                authButton.textContent = '登入';
                authSwitch.innerHTML = '尚未註冊帳號？ <a href="#" onclick="toggleAuthMode()">註冊</a>';
            } else {
                authButton.textContent = '註冊';
                authSwitch.innerHTML = '已有帳號？ <a href="#" onclick="toggleAuthMode()">登入</a>';
            }
        }
        
        // 處理認證表單提交
        function handleAuth(event) {
            event.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (isLoginMode) {
                // 登入邏輯
                alert(`登入功能開發中！\n\n電子郵件：${email}`);
            } else {
                // 註冊邏輯
                alert(`註冊功能開發中！\n\n電子郵件：${email}\n\n註冊成功後將自動登入。`);
            }
        }
        
        // 處理忘記密碼
        function handleForgotPassword() {
            const email = document.getElementById('emailInput').value;
            if (email) {
                alert(`密碼重設郵件將發送至：${email}\n\n此功能開發中。`);
            } else {
                alert('請先輸入您的電子郵件地址');
                document.getElementById('emailInput').focus();
            }
        }
        
        // 處理 Apple 登入
        function handleAppleLogin() {
            alert('Apple 登入功能開發中！\n\n將使用 Apple ID 快速登入。');
        }
        
        // 處理 Google 登入
        function handleGoogleLogin() {
            alert('Google 登入功能開發中！\n\n將使用 Google 帳號快速登入。');
        }
        
        // 顯示輔助說明
        function showHelp() {
            alert('輔助說明\n\n歡迎使用 LENSY！\n\n基本操作：\n• 點擊相機按鈕開始掃描\n• 對準物品拍照即可識別價格\n• 可從相簿選擇照片進行識別\n\n如需更多協助，請聯絡我們。');
        }
        
        // 顯示APP資訊
        function showAppInfo() {
            alert('LENSY - 萬物價格掃描器\n\n版本：1.0.0\n開發者：LENSY Team\n\n使用 AI 技術，精準識別物品並估算價格。\n\n© 2024 LENSY. All rights reserved.');
        }
        
        // 評價APP
        function rateApp() {
            // 如果是 iOS
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                alert('即將跳轉到 App Store...\n\n感謝您的支持！您的評價對我們非常重要。');
                // window.location.href = 'https://apps.apple.com/app/idXXXXXXXXX';
            } 
            // 如果是 Android
            else if (/Android/i.test(navigator.userAgent)) {
                alert('即將跳轉到 Google Play...\n\n感謝您的支持！您的評價對我們非常重要。');
                // window.location.href = 'https://play.google.com/store/apps/details?id=com.lensy.scanner';
            }
            // 網頁版
            else {
                alert('感謝您的支持！\n\n網頁版暫時無法評價，請在手機 App 中進行評價。');
            }
        }
        
        // 分享APP
        async function shareApp() {
            const shareData = {
                title: 'LENSY - 萬物價格掃描器',
                text: '推薦你一個超棒的 APP！\n\nLENSY 可以：\n• 拍照識別任何物品\n• AI 智能估算價格\n• 提供購買建議\n\n快來試試看吧！',
                url: 'https://lynn800741.github.io/price-scanner-app/'
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // 如果不支援原生分享，複製連結
                    const shareText = `${shareData.text}\n\n下載連結：${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('分享連結已複製到剪貼板！\n\n快去分享給朋友吧～');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('分享失敗:', error);
                    alert('分享失敗，請稍後再試');
                }
            }
        }
        
        // 打開AI上傳頁面
        function openAIUpload() {
            const aiUploadPage = document.getElementById('aiUploadPage');
            aiUploadPage.classList.add('active');
        }
        
        // 關閉AI上傳頁面
        function closeAIUpload() {
            const aiUploadPage = document.getElementById('aiUploadPage');
            aiUploadPage.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => {
                aiUploadPage.classList.remove('active');
                aiUploadPage.style.animation = '';
            }, 300);
        }
        
        // 處理AI檔案選擇
        async function handleAIFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 檢查檔案類型
            if (!file.type.startsWith('image/')) {
                alert('請選擇圖片檔案');
                return;
            }
            
            // 顯示分析動畫
            showAIAnalyzing();
            
            try {
                // 讀取圖片
                const imageDataUrl = await readFileAsDataURL(file);
                
                // 調整圖片大小
                const resizedImage = await resizeImage(imageDataUrl, 800, 800);
                
                // 準備 FormData
                const blob = await dataURLtoBlob(resizedImage);
                const formData = new FormData();
                formData.append('image', blob, 'ai_image.jpg');
                
                // 呼叫 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/analyze';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // 儲存分析結果
                        capturedImage = resizedImage;
                        currentAnalysisData = result.data;
                        saveToHistory(result.data);
                        
                        // 延遲一下讓動畫更自然
                        setTimeout(() => {
                            // 隱藏分析動畫
                            hideAIAnalyzing();
                            
                            // 優雅地關閉AI上傳頁面
                            closeAIUpload();
                            
                            // 等待關閉動畫完成後打開聊天
                            setTimeout(() => {
                                openChat();
                            }, 300);
                        }, 1000);
                    } else {
                        throw new Error('分析失敗');
                    }
                } else {
                    throw new Error('API 請求失敗');
                }
            } catch (error) {
                console.error('AI分析錯誤:', error);
                hideAIAnalyzing();
                alert('AI分析失敗，請稍後再試');
            }
            
            // 清除輸入值
            event.target.value = '';
        }
        
        // 顯示AI分析動畫
        function showAIAnalyzing() {
            // 創建分析遮罩
            const analyzeOverlay = document.createElement('div');
            analyzeOverlay.id = 'aiAnalyzeOverlay';
            analyzeOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 5000;
                animation: fadeIn 0.3s ease;
            `;
            
            analyzeOverlay.innerHTML = `
                <div style="width: 80px; height: 80px; margin-bottom: 30px;">
                    <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                        <circle cx="50" cy="50" r="35" stroke="#FF6B35" stroke-width="8" fill="none" 
                                stroke-dasharray="220" stroke-dashoffset="0"
                                style="animation: dashRotate 2s linear infinite;">
                        </circle>
                        <circle cx="50" cy="50" r="25" stroke="#FF8A65" stroke-width="6" fill="none" 
                                stroke-dasharray="157" stroke-dashoffset="0"
                                style="animation: dashRotateReverse 1.5s linear infinite;">
                        </circle>
                    </svg>
                </div>
                <div style="color: white; font-size: 20px; font-weight: 600; margin-bottom: 10px;">
                    AI 正在分析中
                </div>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 16px;">
                    正在深度理解圖片內容...
                </div>
                <style>
                    @keyframes dashRotate {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                    @keyframes dashRotateReverse {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(-360deg); }
                    }
                </style>
            `;
            
            document.body.appendChild(analyzeOverlay);
        }
        
        // 隱藏AI分析動畫
        function hideAIAnalyzing() {
            const analyzeOverlay = document.getElementById('aiAnalyzeOverlay');
            if (analyzeOverlay) {
                analyzeOverlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    analyzeOverlay.remove();
                }, 300);
            }
        }
        
        // 回到首頁（照片列表頁）
        function goToHome() {
            switchPage('listPage');
        }
        
        // 切換頁面
        function switchPage(pageId) {
            // 隱藏所有頁面
            Object.values(pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // 顯示目標頁面
            if (pages[pageId]) {
                pages[pageId].classList.add('active');
                
                // 更新底部導航
                updateBottomNav(pageId);
                
                // 如果切換到相機頁面，啟動相機並隱藏底部導航
                if (pageId === 'cameraPage') {
                    initCamera();
                    bottomNav.classList.add('hidden');
                } else if (pageId === 'resultPage') {
                    // 結果頁面也隱藏底部導航
                    bottomNav.classList.add('hidden');
                } else {
                    // 關閉相機並顯示底部導航
                    stopCamera();
                    bottomNav.classList.remove('hidden');
                }
                
                // 如果切換到列表頁，更新歷史記錄
                if (pageId === 'listPage') {
                    displayHistory();
                }
            }
        }
        
        // 更新底部導航狀態
        function updateBottomNav(activePageId) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // 根據頁面設定對應的導航項目
            if (activePageId === 'listPage') {
                navItems[0].classList.add('active');
            } else if (activePageId === 'settingsPage') {
                navItems[2].classList.add('active');
            }
        }
        
        // 初始化相機
        async function initCamera() {
            try {
                const cameraFeed = document.getElementById('cameraFeed');
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                // 如果支援，加入閃光燈設定
                if ('torch' in navigator.mediaDevices.getSupportedConstraints()) {
                    constraints.video.torch = flashMode === 'on';
                }
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = stream;
            } catch (error) {
                console.error('無法存取相機:', error);
                alert('請允許相機權限以使用此應用程式');
                switchPage('listPage');
            }
        }
        
        // 停止相機
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        
        // 切換閃光燈
        async function toggleFlash() {
            if (!stream) return;
            
            try {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (!capabilities.torch) {
                    alert('此裝置不支援閃光燈功能');
                    return;
                }
                
                flashMode = flashMode === 'off' ? 'on' : 'off';
                await track.applyConstraints({
                    advanced: [{ torch: flashMode === 'on' }]
                });
                
                // 更新圖標狀態（可選）
                const flashBtn = document.querySelector('.control-btn:last-child svg');
                flashBtn.style.fill = flashMode === 'on' ? '#FFD700' : '#fff';
            } catch (error) {
                console.error('閃光燈控制失敗:', error);
                alert('無法控制閃光燈');
            }
        }
        
        // 打開批次分析（從設定頁面）
        function openBatchAnalysis() {
            document.getElementById('multiFileInput').click();
        }
        
        // 處理選擇的檔案
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 檢查檔案類型
            if (!file.type.startsWith('image/')) {
                alert('請選擇圖片檔案');
                return;
            }
            
            // 讀取並顯示圖片
            const reader = new FileReader();
            reader.onload = async function(e) {
                capturedImage = e.target.result;
                
                // 建立圖片元素來調整大小
                const img = new Image();
                img.onload = async function() {
                    const photoCanvas = document.getElementById('photoCanvas');
                    const context = photoCanvas.getContext('2d');
                    
                    // 調整大小
                    const maxWidth = 800;
                    const maxHeight = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    photoCanvas.width = width;
                    photoCanvas.height = height;
                    context.drawImage(img, 0, 0, width, height);
                    
                    // 更新 capturedImage 為調整後的圖片
                    capturedImage = photoCanvas.toDataURL('image/jpeg', 0.7);
                    
                    // 分析圖片
                    analyzeImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // 清除輸入值，允許重複選擇同一檔案
            event.target.value = '';
        }
        
        // 處理多個檔案選擇
        async function handleMultiFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // 檢查檔案數量
            if (files.length > 10) {
                alert('一次最多只能分析 10 張圖片');
                return;
            }
            
            // 檢查檔案類型
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            if (imageFiles.length !== files.length) {
                alert('請只選擇圖片檔案');
                return;
            }
            
            // 顯示批次分析進度
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = loadingOverlay.querySelector('.loading-text');
            loadingOverlay.classList.add('active');
            
            let successCount = 0;
            const results = [];
            
            // 逐一分析圖片
            for (let i = 0; i < imageFiles.length; i++) {
                const file = imageFiles[i];
                loadingText.textContent = `正在分析第 ${i + 1} / ${imageFiles.length} 張圖片...`;
                
                try {
                    // 讀取圖片
                    const imageDataUrl = await readFileAsDataURL(file);
                    
                    // 調整圖片大小
                    const resizedImage = await resizeImage(imageDataUrl, 800, 800);
                    
                    // 準備 FormData
                    const blob = await dataURLtoBlob(resizedImage);
                    const formData = new FormData();
                    formData.append('image', blob, `image${i}.jpg`);
                    
                    // 呼叫 API
                    const API_URL = 'https://price-scanner-backend.vercel.app/api/analyze';
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            successCount++;
                            
                            // 儲存到歷史記錄
                            capturedImage = resizedImage;
                            currentAnalysisData = result.data;
                            saveToHistory(result.data);
                            
                            results.push({
                                image: resizedImage,
                                data: result.data,
                                timestamp: new Date().toISOString()
                            });
                        }
                    }
                } catch (error) {
                    console.error(`分析第 ${i + 1} 張圖片失敗:`, error);
                }
            }
            
            // 隱藏載入動畫
            loadingOverlay.classList.remove('active');
            loadingText.textContent = 'AI 正在分析中...';
            
            // 顯示結果
            if (successCount > 0) {
                alert(`批次分析完成！\n成功：${successCount} 張\n失敗：${imageFiles.length - successCount} 張`);
                
                // 切換到列表頁面並重新載入
                switchPage('listPage');
                displayHistory();
            } else {
                alert('批次分析失敗，請稍後再試');
            }
            
            // 清除輸入值
            event.target.value = '';
        }
        
        // 讀取檔案為 DataURL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 調整圖片大小
        function resizeImage(dataUrl, maxWidth, maxHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = dataUrl;
            });
        }
        
        // DataURL 轉 Blob
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        // 打開匯出對話框
        function openExportDialog() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            
            if (history.length === 0) {
                alert('沒有可匯出的資料');
                return;
            }
            
            // 建立選擇對話框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 4000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 20px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;
            
            content.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h2 style="margin: 0; font-size: 20px;">選擇要匯出的照片</h2>
                </div>
                
                <div style="padding: 15px 20px; background: #f9f9f9; border-bottom: 1px solid #eee;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="margin-right: 10px;">
                        <span style="font-weight: 600;">全選</span>
                    </label>
                </div>
                
                <div id="exportList" style="flex: 1; overflow-y: auto; padding: 15px;">
                    ${history.map((item, index) => `
                        <label style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 10px;">
                            <input type="checkbox" class="export-item" value="${index}" style="margin-right: 10px;">
                            <img src="${item.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${item.name}</div>
                                <div style="font-size: 12px; color: #666;">${formatPrice(item.price)}</div>
                            </div>
                        </label>
                    `).join('')}
                </div>
                
                <div style="padding: 15px 20px; border-top: 1px solid #eee; background: #fff;">
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportToExcel()" style="flex: 1; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600;">
                            匯出 Excel
                        </button>
                        <button onclick="closeExportDialog()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600;">
                            取消
                        </button>
                    </div>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // 保存對話框參考
            window.currentExportDialog = dialog;
        }
        
        // 全選/取消全選
        window.toggleSelectAll = function() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.export-item');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        };
        
        // 關閉匯出對話框
        window.closeExportDialog = function() {
            if (window.currentExportDialog) {
                window.currentExportDialog.remove();
                window.currentExportDialog = null;
            }
        };
        
        // 匯出到 Excel
        window.exportToExcel = async function() {
            const selectedIndexes = Array.from(document.querySelectorAll('.export-item:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedIndexes.length === 0) {
                alert('請至少選擇一個項目');
                return;
            }
            
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const selectedItems = selectedIndexes.map(index => history[index]);
            
            try {
                // 準備資料
                const exportData = selectedItems.map(item => ({
                    '物品名稱': item.name,
                    '價格': formatPrice(item.price),
                    '價格說明': item.data.priceNote || '',
                    '描述': item.data.description || '',
                    '材質': item.data.material || '',
                    '用途': item.data.usage || '',
                    '分類': item.data.category || '',
                    '品牌': item.data.brand || '',
                    '購買地點': item.data.availability || '',
                    '掃描日期': formatDateDisplay(item.timestamp)
                }));
                
                // 呼叫後端 API 生成 Excel
                const API_URL = 'https://price-scanner-backend.vercel.app/api/export/excel';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: exportData })
                });
                
                if (response.ok) {
                    // 下載檔案
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lensy_export_${new Date().getTime()}.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    closeExportDialog();
                    alert('Excel 檔案已下載！');
                } else {
                    throw new Error('匯出失敗');
                }
                
            } catch (error) {
                console.error('匯出錯誤:', error);
                // 如果 API 還未實現，使用 CSV 替代
                exportToCSV(selectedItems);
            }
        };
        
        // 匯出為 CSV（備用方案）
        function exportToCSV(items) {
            const headers = ['物品名稱', '價格', '價格說明', '描述', '材質', '用途', '分類', '品牌', '購買地點', '掃描日期'];
            const rows = items.map(item => [
                item.name,
                formatPrice(item.price),
                item.data.priceNote || '',
                item.data.description || '',
                item.data.material || '',
                item.data.usage || '',
                item.data.category || '',
                item.data.brand || '',
                item.data.availability || '',
                formatDateDisplay(item.timestamp)
            ]);
            
            // 建立 CSV 內容
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // 加入 BOM 以支援中文
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 下載檔案
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lensy_export_${new Date().getTime()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            closeExportDialog();
            alert('CSV 檔案已下載！\n\n注意：後端 Excel 功能尚未實現，暫時使用 CSV 格式。');
        }
        
        // 拍照功能
        async function capturePhoto() {
            const cameraFeed = document.getElementById('cameraFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const context = photoCanvas.getContext('2d');
            
            // 設定畫布尺寸
            const maxWidth = 800;
            const maxHeight = 800;
            
            let width = cameraFeed.videoWidth;
            let height = cameraFeed.videoHeight;
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            photoCanvas.width = width;
            photoCanvas.height = height;
            context.drawImage(cameraFeed, 0, 0, width, height);
            
            // 轉換為 base64
            capturedImage = photoCanvas.toDataURL('image/jpeg', 0.7);
            
            // 觸發分析
            analyzeImage();
        }
        
        // 長按拍照按鈕時選擇單張照片
        function setupCaptureButton() {
            const captureBtn = document.querySelector('.capture-btn');
            let pressTimer;
            
            // 長按開始
            captureBtn.addEventListener('mousedown', function() {
                pressTimer = setTimeout(function() {
                    document.getElementById('fileInput').click();
                }, 800); // 800ms 後觸發
            });
            
            captureBtn.addEventListener('touchstart', function() {
                pressTimer = setTimeout(function() {
                    document.getElementById('fileInput').click();
                }, 800);
            });
            
            // 取消長按
            captureBtn.addEventListener('mouseup', function() {
                clearTimeout(pressTimer);
            });
            
            captureBtn.addEventListener('touchend', function() {
                clearTimeout(pressTimer);
            });
            
            captureBtn.addEventListener('mouseleave', function() {
                clearTimeout(pressTimer);
            });
        }
        
        // 分析圖片
        async function analyzeImage() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const resultContent = document.getElementById('resultContent');
            
            // 顯示載入動畫
            loadingOverlay.classList.add('active');
            
            try {
                // 將 canvas 轉換為 blob
                const photoCanvas = document.getElementById('photoCanvas');
                const blob = await new Promise(resolve => {
                    photoCanvas.toBlob(resolve, 'image/jpeg', 0.7);
                });
                
                // 準備 FormData
                const formData = new FormData();
                formData.append('image', blob, 'capture.jpg');
                
                // 呼叫後端 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/analyze';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }
                
                const result = await response.json();
                
                // 隱藏載入動畫
                loadingOverlay.classList.remove('active');
                
                if (result.success && result.data) {
                    // 保存當前分析數據
                    currentAnalysisData = result.data;
                    
                    // 顯示結果
                    displayResult(result.data);
                    
                    // 儲存到歷史記錄
                    saveToHistory(result.data);
                    
                    // 切換到結果頁面
                    switchPage('resultPage');
                } else {
                    throw new Error(result.error || '分析失敗');
                }
                
            } catch (error) {
                console.error('分析錯誤:', error);
                loadingOverlay.classList.remove('active');
                alert('分析失敗：' + error.message + '\n請確認網路連線並重試');
            }
        }
        
        // 儲存到歷史記錄
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            
            const historyItem = {
                id: Date.now(),
                name: data.name,
                price: data.price,
                image: capturedImage,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            history.unshift(historyItem);
            
            // 只保留最新 50 筆
            history = history.slice(0, 50);
            
            localStorage.setItem('scanHistory', JSON.stringify(history));
            
            // 設定當前聊天項目 ID
            currentChatItemId = historyItem.id;
            currentHistoryItem = historyItem;  // 保存當前歷史項目
        }
        
        // 搜尋歷史記錄
        function searchHistory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            
            // 過濾符合搜尋條件的項目
            const filteredHistory = history.filter(item => {
                return item.name.toLowerCase().includes(searchTerm) ||
                       item.price.toLowerCase().includes(searchTerm);
            });
            
            // 顯示過濾後的結果
            displayHistoryItems(filteredHistory);
        }
        
        // 顯示歷史記錄項目（共用函數）
        function displayHistoryItems(items) {
            const emptyState = document.getElementById('emptyState');
            const historySection = document.getElementById('historySection');
            
            if (items.length === 0) {
                emptyState.style.display = 'flex';
                historySection.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                historySection.style.display = 'block';
                
                // 按月份分組
                const groupedByMonth = {};
                items.forEach(item => {
                    const date = new Date(item.timestamp);
                    const monthKey = `${date.getFullYear()}年${date.getMonth() + 1}月`;
                    
                    if (!groupedByMonth[monthKey]) {
                        groupedByMonth[monthKey] = [];
                    }
                    groupedByMonth[monthKey].push(item);
                });
                
                // 生成HTML
                let html = '';
                Object.keys(groupedByMonth).forEach(month => {
                    html += `<div class="month-label">${month}</div>`;
                    html += '<div class="history-grid">';
                    
                    groupedByMonth[month].forEach(item => {
                        html += `
                            <div class="history-item ${selectedItems.has(item.id) ? 'selected' : ''}" 
                                 onclick="handleHistoryItemClick(event, ${item.id})"
                                 data-id="${item.id}">
                                <div class="history-item-checkbox ${selectedItems.has(item.id) ? 'checked' : ''}" 
                                     onclick="toggleItemSelection(event, ${item.id})"></div>
                                <img src="${item.image}" alt="${item.name}" class="history-img">
                                <div class="history-info">
                                    <div class="history-name">${item.name}</div>
                                    <div class="history-price">${formatPrice(item.price)}</div>
                                    <div class="history-date">${formatDateDisplay(item.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                historySection.innerHTML = html;
            }
        }
        
        // 顯示歷史記錄
        function displayHistory() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            displayHistoryItems(history);
        }
        
        // 切換選取模式
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            const selectBtn = document.getElementById('selectBtn');
            const batchToolbar = document.getElementById('batchToolbar');
            const listPage = document.getElementById('listPage');
            
            if (isSelectMode) {
                selectBtn.textContent = '取消';
                selectBtn.classList.add('active');
                listPage.classList.add('select-mode');
                selectedItems.clear();
                updateSelectedCount();
            } else {
                selectBtn.textContent = '選取';
                selectBtn.classList.remove('active');
                listPage.classList.remove('select-mode');
                batchToolbar.classList.remove('active');
                selectedItems.clear();
                // 移除所有選中狀態
                document.querySelectorAll('.history-item').forEach(item => {
                    item.classList.remove('selected');
                    item.querySelector('.history-item-checkbox').classList.remove('checked');
                });
            }
        }
        
        // 處理歷史項目點擊
        function handleHistoryItemClick(event, id) {
            if (isSelectMode) {
                event.preventDefault();
                toggleItemSelection(event, id);
            } else {
                showHistoryItem(id);
            }
        }
        
        // 切換項目選擇狀態
        function toggleItemSelection(event, id) {
            event.stopPropagation();
            
            const historyItem = document.querySelector(`.history-item[data-id="${id}"]`);
            const checkbox = historyItem.querySelector('.history-item-checkbox');
            
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
                historyItem.classList.remove('selected');
                checkbox.classList.remove('checked');
            } else {
                selectedItems.add(id);
                historyItem.classList.add('selected');
                checkbox.classList.add('checked');
            }
            
            updateSelectedCount();
        }
        
        // 更新選中數量
        function updateSelectedCount() {
            const count = selectedItems.size;
            document.getElementById('selectedCount').textContent = count;
            
            const batchToolbar = document.getElementById('batchToolbar');
            if (count > 0) {
                batchToolbar.classList.add('active');
            } else {
                batchToolbar.classList.remove('active');
            }
        }
        
        // 批量分享
        async function batchShare() {
            if (selectedItems.size === 0) {
                alert('請選擇要分享的項目');
                return;
            }
            
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const selectedData = Array.from(selectedItems).map(id => 
                history.find(item => item.id === id)
            ).filter(Boolean);
            
            try {
                // 建立分享文字
                let shareText = '我用 LENSY 掃描了以下物品：\n\n';
                selectedData.forEach(item => {
                    shareText += `• ${item.name} - ${formatPrice(item.price)}\n`;
                });
                shareText += '\n立即試用：https://lynn800741.github.io/price-scanner-app/';
                
                if (navigator.share) {
                    await navigator.share({
                        title: 'LENSY - 萬物價格掃描器',
                        text: shareText
                    });
                } else {
                    await navigator.clipboard.writeText(shareText);
                    alert('分享內容已複製到剪貼板！');
                }
                
                // 退出選取模式
                toggleSelectMode();
                
            } catch (error) {
                console.error('分享失敗:', error);
                if (error.name !== 'AbortError') {
                    alert('分享失敗，請稍後再試');
                }
            }
        }
        
        // 批量刪除
        function batchDelete() {
            if (selectedItems.size === 0) {
                alert('請選擇要刪除的項目');
                return;
            }
            
            const confirmMsg = `確定要刪除 ${selectedItems.size} 個項目嗎？`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // 從歷史記錄中刪除選中的項目
            let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            history = history.filter(item => !selectedItems.has(item.id));
            localStorage.setItem('scanHistory', JSON.stringify(history));
            
            // 同時刪除相關的聊天記錄
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            selectedItems.forEach(id => {
                delete chatHistory[id];
            });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            
            // 退出選取模式並重新顯示
            toggleSelectMode();
            displayHistory();
        }
        
        // 顯示歷史記錄項目
        function showHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const item = history.find(h => h.id === id);
            
            if (item) {
                capturedImage = item.image;
                currentAnalysisData = item.data;
                currentChatItemId = item.id;  // 設定當前聊天項目 ID
                currentHistoryItem = item;     // 保存當前歷史項目
                displayResult(item.data);
                
                // 切換到結果頁面
                switchPage('resultPage');
            }
        }
        
        // 切換結果選單
        function toggleResultMenu() {
            const dropdown = document.getElementById('resultDropdown');
            dropdown.classList.toggle('active');
            
            // 點擊其他地方關閉選單
            setTimeout(() => {
                document.addEventListener('click', closeResultMenu);
            }, 100);
        }
        
        // 關閉結果選單
        function closeResultMenu(event) {
            const dropdown = document.getElementById('resultDropdown');
            const menuBtn = document.querySelector('.result-menu-btn');
            
            if (!dropdown.contains(event.target) && !menuBtn.contains(event.target)) {
                dropdown.classList.remove('active');
                document.removeEventListener('click', closeResultMenu);
            }
        }
        
        // 重新分析圖片
        async function reanalyzeImage() {
            // 關閉選單
            document.getElementById('resultDropdown').classList.remove('active');
            
            // 確認重新分析
            if (!confirm('確定要重新識別這個物品嗎？')) {
                return;
            }
            
            // 顯示載入動畫
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            try {
                // 將 base64 圖片轉換為 blob
                const base64Data = capturedImage.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                
                // 準備 FormData
                const formData = new FormData();
                formData.append('image', blob, 'capture.jpg');
                
                // 呼叫後端 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/analyze';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }
                
                const result = await response.json();
                
                // 隱藏載入動畫
                loadingOverlay.classList.remove('active');
                
                if (result.success && result.data) {
                    // 更新當前分析數據
                    currentAnalysisData = result.data;
                    
                    // 更新歷史記錄
                    let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
                    const index = history.findIndex(h => h.id === currentHistoryItem.id);
                    if (index !== -1) {
                        history[index].data = result.data;
                        history[index].name = result.data.name;
                        history[index].price = result.data.price;
                        localStorage.setItem('scanHistory', JSON.stringify(history));
                    }
                    
                    // 重新顯示結果
                    displayResult(result.data);
                    
                    alert('物品識別已更新！');
                } else {
                    throw new Error(result.error || '分析失敗');
                }
                
            } catch (error) {
                console.error('重新分析錯誤:', error);
                loadingOverlay.classList.remove('active');
                alert('重新分析失敗：' + error.message);
            }
        }
        
        // 編輯物品名稱
        function editItemName() {
            // 關閉選單
            document.getElementById('resultDropdown').classList.remove('active');
            
            // 顯示編輯對話框
            const editDialog = document.getElementById('editDialog');
            const editInput = document.getElementById('editNameInput');
            editInput.value = currentAnalysisData.name;
            editDialog.classList.add('active');
            
            // 聚焦輸入框
            setTimeout(() => editInput.focus(), 100);
        }
        
        // 關閉編輯對話框
        function closeEditDialog() {
            document.getElementById('editDialog').classList.remove('active');
        }
        
        // 儲存編輯的名稱
        function saveEditedName() {
            const newName = document.getElementById('editNameInput').value.trim();
            
            if (!newName) {
                alert('請輸入新名稱');
                return;
            }
            
            // 更新當前數據
            currentAnalysisData.name = newName;
            
            // 更新歷史記錄
            let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const index = history.findIndex(h => h.id === currentHistoryItem.id);
            if (index !== -1) {
                history[index].name = newName;
                history[index].data.name = newName;
                localStorage.setItem('scanHistory', JSON.stringify(history));
            }
            
            // 重新顯示結果
            displayResult(currentAnalysisData);
            
            // 關閉對話框
            closeEditDialog();
            
            // 更新列表顯示
            displayHistory();
        }
        
        // 刪除當前項目
        function deleteCurrentItem() {
            // 關閉選單
            document.getElementById('resultDropdown').classList.remove('active');
            
            if (!confirm('確定要刪除這個項目嗎？')) {
                return;
            }
            
            // 從歷史記錄中刪除
            let history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            history = history.filter(item => item.id !== currentHistoryItem.id);
            localStorage.setItem('scanHistory', JSON.stringify(history));
            
            // 刪除相關聊天記錄
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            delete chatHistory[currentHistoryItem.id];
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            
            // 關閉結果頁面，回到列表
            closeResult();
            
            // 更新列表顯示
            displayHistory();
        }
        
        // 格式化日期顯示
        function formatDateDisplay(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            return `${year}/${month}/${day}`;
        }
        
        // 格式化日期（保留原函數用於其他地方）
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '剛剛';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} 分鐘前`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} 小時前`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} 天前`;
            
            return date.toLocaleDateString('zh-TW');
        }
        
        // 顯示結果
        function displayResult(data) {
            const resultContent = document.getElementById('resultContent');
            
            // 生成購買連結
            let purchaseLinks = '';
            if (data.purchaseLinks && data.purchaseLinks.online && data.purchaseLinks.online.length > 0) {
                purchaseLinks = `
                    <div class="info-card">
                        <h3 class="info-card-title">購買管道</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${data.purchaseLinks.online.map(link => `
                                <a href="${getPlatformUrl(link.platform, link.searchTerm)}" 
                                   target="_blank" 
                                   style="display: inline-flex; align-items: center; padding: 8px 16px; background: #FF6B35; color: white; border-radius: 20px; text-decoration: none; font-size: 14px;">
                                    ${link.platform}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            resultContent.innerHTML = `
                <img src="${capturedImage}" alt="拍攝的物品" class="result-image">
                
                <h2 class="result-name">${data.name}</h2>
                
                <div class="price-section">
                    <div style="font-size: 16px; opacity: 0.9;">預估價格</div>
                    <div class="price-value">${formatPrice(data.price)}</div>
                    <div style="font-size: 14px; opacity: 0.8;">${data.priceNote}</div>
                </div>
                
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="action-button btn-chat" onclick="openChat()">
                        詢問 AI
                    </button>
                    <button class="action-button btn-share" onclick="shareResult()">
                        分享
                    </button>
                </div>
                
                ${purchaseLinks}
                
                <div class="info-card">
                    <h3 class="info-card-title">基本資訊</h3>
                    <p class="info-card-content">${data.description}</p>
                </div>
                
                ${data.category ? `
                <div class="info-card">
                    <h3 class="info-card-title">分類</h3>
                    <p class="info-card-content">${data.category}</p>
                </div>
                ` : ''}
                
                ${data.brand ? `
                <div class="info-card">
                    <h3 class="info-card-title">品牌</h3>
                    <p class="info-card-content">${data.brand}</p>
                </div>
                ` : ''}
                
                <div class="info-card">
                    <h3 class="info-card-title">在哪裡買</h3>
                    <p class="info-card-content">${data.availability}</p>
                </div>
                
                <p class="disclaimer-text">所有資訊皆由 GPT 產出</p>
            `;
        }
        
        // 取得平台 URL
        function getPlatformUrl(platform, searchTerm) {
            const urls = {
                '蝦皮購物': `https://shopee.tw/search?keyword=${encodeURIComponent(searchTerm)}`,
                'PChome 24h': `https://24h.pchome.com.tw/search/?q=${encodeURIComponent(searchTerm)}`,
                'momo購物網': `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${encodeURIComponent(searchTerm)}`,
                '露天拍賣': `https://find.ruten.com.tw/s/?q=${encodeURIComponent(searchTerm)}`,
                'Yahoo拍賣': `https://tw.search.yahoo.com/search?p=${encodeURIComponent(searchTerm)}`
            };
            return urls[platform] || '#';
        }
        
        // 打開聊天頁面
        function openChat() {
            // 設定當前聊天項目 ID
            const history = JSON.parse(localStorage.getItem('scanHistory') || '[]');
            const currentItem = history.find(item => 
                item.image === capturedImage && 
                item.data.name === currentAnalysisData.name
            );
            
            if (currentItem) {
                currentChatItemId = currentItem.id;
                loadChatHistory();
                chatPage.classList.add('active');
                
                // 如果沒有歷史對話，顯示歡迎訊息
                const chatHistory = getChatHistory();
                if (chatHistory.length === 0) {
                    // 第一次對話，隱藏重新查看圖片按鈕
                    document.getElementById('viewImageSection').style.display = 'none';
                    
                    // 根據物品類型生成個性化的歡迎訊息
                    let welcomeMessage = `## 你好！我剛剛仔細觀察了這個「${currentAnalysisData.name}」\n\n發現了一些有趣的資訊想與你分享！\n\n`;
                    
                    // 添加一個有趣的開場
                    if (currentAnalysisData.category && currentAnalysisData.category.includes('電子')) {
                        welcomeMessage += `📱 **作為一個科技產品**，它代表著現代生活的便利性。`;
                    } else if (currentAnalysisData.category && currentAnalysisData.category.includes('食')) {
                        welcomeMessage += `🍽️ **民以食為天**，讓我們來深入了解這個美味的選擇。`;
                    } else if (currentAnalysisData.brand) {
                        welcomeMessage += `🏷️ **${currentAnalysisData.brand}** 這個品牌有著獨特的市場定位。`;
                    } else {
                        welcomeMessage += `✨ **每個物品都有它獨特的故事和價值**。`;
                    }
                    
                    welcomeMessage += `\n\n### 我可以為你提供：\n\n`;
                    welcomeMessage += `• **深入的產品分析**——從各個角度剖析優缺點\n`;
                    welcomeMessage += `• **使用技巧和保養建議**——讓物品發揮最大價值\n`;
                    welcomeMessage += `• **市場趨勢和價格走向**——掌握最佳購買時機\n`;
                    welcomeMessage += `• **相關的有趣知識**——拓展視野，增長見識\n\n`;
                    welcomeMessage += `有什麼想了解的嗎？或者讓我先分享一些你可能感興趣的資訊？`;
                    
                    addMessage('assistant', welcomeMessage);
                    
                    // 第一次對話，記錄已經看過圖片
                    const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
                    if (!allChats[currentChatItemId]) {
                        allChats[currentChatItemId] = [];
                    }
                    allChats[currentChatItemId].imageAnalyzed = true;
                    localStorage.setItem('chatHistory', JSON.stringify(allChats));
                }
                
                // 更新快速提示詞
                updateQuickPrompts();
            }
        }
        
        // 更新快速提示詞
        function updateQuickPrompts() {
            const quickPrompts = document.getElementById('quickPrompts');
            let prompts = [
                '深度分析這個產品的優缺點',
                '和其他同類產品比較如何？',
                '有什麼隱藏的使用技巧嗎？',
                '這個價格在市場上算合理嗎？',
                '長期使用需要注意什麼？'
            ];
            
            // 根據物品類型動態調整提示詞
            if (currentAnalysisData.category) {
                if (currentAnalysisData.category.includes('食') || currentAnalysisData.category.includes('餐')) {
                    prompts = [
                        '詳細分析營養價值和健康影響',
                        '有什麼特別的料理方式嗎？',
                        '如何判斷品質好壞？',
                        '保存方法和期限建議',
                        '搭配什麼食材最合適？'
                    ];
                } else if (currentAnalysisData.category.includes('電子') || currentAnalysisData.category.includes('3C')) {
                    prompts = [
                        '詳細規格分析和性能評估',
                        '這個世代的技術有何突破？',
                        '未來會不會很快被淘汰？',
                        '有什麼隱藏功能或彩蛋？',
                        '如何發揮最大性能？'
                    ];
                } else if (currentAnalysisData.category.includes('服飾') || currentAnalysisData.category.includes('衣')) {
                    prompts = [
                        '材質特性和穿著體驗如何？',
                        '適合什麼場合和搭配？',
                        '如何辨別真偽和品質？',
                        '保養和清洗的專業建議',
                        '這個設計的流行趨勢分析'
                    ];
                } else if (currentAnalysisData.category.includes('玩具') || currentAnalysisData.category.includes('模型')) {
                    prompts = [
                        '收藏價值和未來升值潛力',
                        '有什麼特別的設計巧思？',
                        '如何保養維持最佳狀態？',
                        '這個系列的歷史和文化意義',
                        '適合什麼年齡層？安全嗎？'
                    ];
                }
            }
            
            // 如果有品牌資訊，加入品牌相關提示
            if (currentAnalysisData.brand && currentAnalysisData.brand !== '未知') {
                prompts.splice(2, 0, `${currentAnalysisData.brand}這個品牌的故事和特色`);
            }
            
            quickPrompts.innerHTML = prompts.slice(0, 5).map(prompt => 
                `<span class="prompt-chip" onclick="sendQuickPrompt('${prompt}')">${prompt}</span>`
            ).join('');
        }
        
        // 發送快速提示
        function sendQuickPrompt(prompt) {
            document.getElementById('chatInput').value = prompt;
            sendMessage();
        }
        
        // 關閉聊天頁面
        function closeChat() {
            chatPage.classList.remove('active');
            currentChatItemId = null;
        }
        
        // 獲取聊天歷史
        function getChatHistory() {
            if (!currentChatItemId) return [];
            const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            return allChats[currentChatItemId] || [];
        }
        
        // 檢查是否已分析過圖片
        function hasImageBeenAnalyzed() {
            if (!currentChatItemId) return false;
            const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            return allChats[currentChatItemId] && allChats[currentChatItemId].imageAnalyzed;
        }
        
        // 保存聊天歷史
        function saveChatHistory(messages) {
            if (!currentChatItemId) return;
            const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            allChats[currentChatItemId] = messages;
            // 保留 imageAnalyzed 標記
            const imageAnalyzed = allChats[currentChatItemId] && allChats[currentChatItemId].imageAnalyzed;
            if (imageAnalyzed) {
                allChats[currentChatItemId].imageAnalyzed = true;
            }
            localStorage.setItem('chatHistory', JSON.stringify(allChats));
        }
        
        // 載入聊天歷史
        function loadChatHistory() {
            const messages = getChatHistory();
            const chatMessages = document.getElementById('chatMessages');
            const viewImageSection = document.getElementById('viewImageSection');
            chatMessages.innerHTML = '';
            
            // 如果有歷史，顯示重新查看圖片按鈕
            if (messages.length > 0) {
                viewImageSection.style.display = 'flex';
            } else {
                viewImageSection.style.display = 'none';
            }
            
            messages.forEach(msg => {
                if (msg.role && msg.content) {  // 確保訊息格式正確
                    // 載入歷史訊息時不使用打字動畫
                    addMessageToUI(msg.role, msg.content, false);
                }
            });
            
            // 滾動到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 簡單的 Markdown 解析函數
        function parseMarkdown(text) {
            // 處理標題
            text = text.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // 處理粗體
            text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 處理斜體
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 處理行內代碼
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // 處理分隔線
            text = text.replace(/^---+$/gm, '<hr>');
            
            // 處理無序列表
            text = text.replace(/^• (.*?)$/gm, '<li>$1</li>');
            text = text.replace(/^- (.*?)$/gm, '<li>$1</li>');
            text = text.replace(/^(\s*)<li>/gm, '$1<ul><li>');
            text = text.replace(/<\/li>\n(?!<li>)/g, '</li></ul>\n');
            
            // 處理有序列表
            text = text.replace(/^\d+\. (.*?)$/gm, '<li>$1</li>');
            
            // 處理段落
            text = text.split('\n\n').map(para => {
                if (!para.match(/^<[^>]+>/)) {
                    return `<p>${para}</p>`;
                }
                return para;
            }).join('\n');
            
            // 處理換行
            text = text.replace(/\n/g, '<br>');
            
            // 清理多餘的 <br> 標籤
            text = text.replace(/<br><h/g, '<h');
            text = text.replace(/<\/h(\d)><br>/g, '</h$1>');
            text = text.replace(/<br><ul>/g, '<ul>');
            text = text.replace(/<\/ul><br>/g, '</ul>');
            text = text.replace(/<br><li>/g, '<li>');
            text = text.replace(/<br><hr>/g, '<hr>');
            text = text.replace(/<hr><br>/g, '<hr>');
            
            return text;
        }
        
        // 打字動畫效果
        async function typewriterEffect(element, text, speed = 30) {
            element.innerHTML = '';
            const parsedHTML = parseMarkdown(text);
            
            // 創建一個臨時元素來解析 HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = parsedHTML;
            
            // 遍歷所有節點並逐字顯示
            async function typeNode(node, targetElement) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // 文字節點：逐字顯示
                    const text = node.textContent;
                    for (let i = 0; i < text.length; i++) {
                        targetElement.innerHTML += text[i];
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // 元素節點：創建元素並遞歸處理子節點
                    const newElement = document.createElement(node.tagName.toLowerCase());
                    
                    // 複製屬性
                    Array.from(node.attributes).forEach(attr => {
                        newElement.setAttribute(attr.name, attr.value);
                    });
                    
                    targetElement.appendChild(newElement);
                    
                    // 處理子節點
                    for (const childNode of node.childNodes) {
                        await typeNode(childNode, newElement);
                    }
                }
            }
            
            // 處理所有子節點
            for (const childNode of tempDiv.childNodes) {
                await typeNode(childNode, element);
            }
        }
        
        // 添加訊息到 UI（修改版，支援打字動畫）
        async function addMessageToUI(role, content, useTypewriter = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'user') {
                // 用戶訊息保持原樣
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            } else {
                // AI 訊息
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageDiv.appendChild(messageContent);
                
                if (useTypewriter) {
                    // 使用打字動畫
                    chatMessages.appendChild(messageDiv);
                    await typewriterEffect(messageContent, content);
                } else {
                    // 直接顯示（用於載入歷史訊息）
                    messageContent.innerHTML = parseMarkdown(content);
                }
            }
            
            if (!messageDiv.parentNode) {
                chatMessages.appendChild(messageDiv);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加訊息並保存（修改版，支援打字動畫）
        async function addMessage(role, content, useTypewriter = true) {
            const messages = getChatHistory();
            messages.push({ role, content, timestamp: new Date().toISOString() });
            saveChatHistory(messages);
            await addMessageToUI(role, content, useTypewriter);
        }
        
        // 發送帶圖片的訊息
        async function sendMessageWithImage(message) {
            if (!message) {
                message = document.getElementById('chatInput').value.trim();
            }
            
            if (!message) return;
            
            // 清空輸入框
            if (!message || message === document.getElementById('chatInput').value.trim()) {
                document.getElementById('chatInput').value = '';
                document.getElementById('chatInput').style.height = 'auto';
            }
            
            // 發送帶圖片的請求
            await sendMessageInternal(message, true);
        }
        
        // 發送訊息
        async function sendMessage() {
            const message = document.getElementById('chatInput').value.trim();
            if (!message) return;
            
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').style.height = 'auto';
            
            // 檢查是否是第一次對話
            const isFirstMessage = !hasImageBeenAnalyzed();
            await sendMessageInternal(message, isFirstMessage);
        }
        
        // 內部發送訊息函數
        async function sendMessageInternal(message, includeImage = false) {
            const chatSendBtn = document.getElementById('chatSendBtn');
            
            // 添加用戶訊息
            addMessage('user', message);
            
            // 禁用發送按鈕
            chatSendBtn.disabled = true;
            
            // 顯示載入動畫
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-content">
                    <div class="chat-loading">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // 準備請求數據
                const formData = new FormData();
                
                // 只在需要時包含圖片
                if (includeImage) {
                    // 將 base64 圖片轉換為 Blob
                    const base64Data = capturedImage.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/jpeg' });
                    
                    formData.append('image', blob, 'item.jpg');
                    
                    // 標記已分析過圖片
                    const allChats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
                    if (!allChats[currentChatItemId]) {
                        allChats[currentChatItemId] = [];
                    }
                    allChats[currentChatItemId].imageAnalyzed = true;
                    localStorage.setItem('chatHistory', JSON.stringify(allChats));
                }
                
                formData.append('message', message);
                formData.append('itemInfo', JSON.stringify(currentAnalysisData));
                formData.append('chatHistory', JSON.stringify(getChatHistory()));
                formData.append('includeImage', includeImage.toString());
                
                // 呼叫 API
                const API_URL = 'https://price-scanner-backend.vercel.app/api/chat';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('API 請求失敗');
                }
                
                const result = await response.json();
                
                // 移除載入動畫
                loadingDiv.remove();
                
                if (result.success) {
                    // 添加 AI 回覆
                    addMessage('assistant', result.data.reply);
                } else {
                    throw new Error(result.error || '回覆失敗');
                }
                
            } catch (error) {
                console.error('聊天錯誤:', error);
                loadingDiv.remove();
                addMessage('assistant', '抱歉，我現在無法回答您的問題。請稍後再試。');
            } finally {
                // 重新啟用發送按鈕
                chatSendBtn.disabled = false;
            }
        }
        
        // 監聽輸入框 Enter 鍵
        document.getElementById('chatInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // 自動調整輸入框高度
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // 分享結果
        async function shareResult() {
            if (!currentAnalysisData) {
                alert('沒有可分享的資料');
                return;
            }
            
            try {
                // 準備分享數據
                const shareData = {
                    name: currentAnalysisData.name,
                    price: currentAnalysisData.price,
                    priceNote: currentAnalysisData.priceNote,
                    description: currentAnalysisData.description,
                    availability: currentAnalysisData.availability,
                    purchaseLinks: currentAnalysisData.purchaseLinks,
                    image: capturedImage
                };
                
                // 呼叫後端 API 生成分享連結
                const API_URL = 'https://price-scanner-backend.vercel.app/api/share';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shareData)
                });
                
                if (!response.ok) {
                    throw new Error('分享失敗');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const shareUrl = `https://lynn800741.github.io/price-scanner-app/share.html?id=${result.shareId}`;
                    const shareText = `我用 LENSY 發現了「${currentAnalysisData.name}」\n價格：${formatPrice(currentAnalysisData.price)}\n${currentAnalysisData.description}\n\n查看詳情：${shareUrl}`;
                    
                    if (navigator.share) {
                        navigator.share({
                            title: 'LENSY - 萬物價格掃描器',
                            text: shareText,
                            url: shareUrl
                        }).catch(err => console.log('分享取消'));
                    } else {
                        // 複製到剪貼板
                        navigator.clipboard.writeText(shareText).then(() => {
                            alert('分享連結已複製到剪貼板！');
                        });
                    }
                } else {
                    throw new Error(result.error || '分享失敗');
                }
                
            } catch (error) {
                console.error('分享錯誤:', error);
                // 如果 API 還未實現，使用本地分享
                const shareText = `我用 LENSY 發現了「${currentAnalysisData.name}」\n價格：${formatPrice(currentAnalysisData.price)}\n${currentAnalysisData.description}\n\n立即試用：https://lynn800741.github.io/price-scanner-app/`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'LENSY - 萬物價格掃描器',
                        text: shareText
                    }).catch(err => console.log('分享取消'));
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('分享文字已複製到剪貼板！\n\n注意：分享連結功能需要後端支援。');
                    });
                }
            }
        }
        
        // 關閉結果頁面
        function closeResult() {
            switchPage('listPage');
        }
        
        // 清理資源
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
        
        // 測試 AI 功能是否正常
        console.log('AI Upload function loaded:', typeof openAIUpload);
        console.log('AI Upload page element:', document.getElementById('aiUploadPage'));
    </script>
</body>
</html>
